# 设计文档：向量化的表达式求值

- 作者：鄢程鹏、蔡涛
- 原始提案：<https://github.com/pingcap/tidb/issues/9245>

## 概要

设计一个新的表达式求值的框架，使得表达式以向量为求值的对象，而非以行为求值的对象，减少表达式计算的开销，提高表达式计算的效率

## 背景

在当前的 tidb 版本中，表达式是按行进行求值计算的。对于输入中传入的一个 chunk，需要进行多次函数调用才能确定一个 chunk 中每行的表达式计算后的结果，非常低效。我们可以拓展表达式求值的框架，增加以列为单位的表达式求值函数。做到对于一个传入的 chunk，只需要进行一次函数调用，即可求得一个 chunk 中表达式的值。最终希望达到的效果是通过这种方式使得表达式求值更加高效、快速。

## 提案

我们此次的项目内容是需要对现有的表达式求值框架进行改进。现有的表达式求值接口 Expression 位于 expression 包中，在 Expression 接口现有的求值函数中，所有已经定义的表达式求值函数 EvalXX(XX为表达式求值结果的返回值类型)都是以行为单位对表达式进行处理的。我们需要为其添加以向量为单位进行表达式计算的函数来完善其表达式计算的框架，从而可以达到，对于每次通过到达 projection 算子的 chunk，经过一次表达式求值即可得到结果，而不是像原来框架中对给定 chunk 的每一行都调用一次表达式求值的函数。

首先，我们需要增加以向量为单位进行表达式求值的函数来完善当前的表达式求值框架，我们需要在原来的 Expression 接口上定义 ColEvalXX 函数，它与原来 EvalXX 函数的不同之处在于，前者一次处理一个 chunk，直接得到一个 chunk 中所有(逻辑)行表达式计算的结果，而后者一次只处理一行，它需要通过多次调用表达式求值函数才能得到对应 chunk 表达式求值后的结果。不仅如此，我们还需要定义一个能够保存 ColEvalXX 函数计算所得结果的数据结构，它应该足够通用，能表示所有的类型，并且它还需要足够紧凑，尽量节省内存。因此我们选择原本就存在于 util/chunk 包中的的Column 结构。

接着，当在 Expression 接口中添加了以向量为单位进行表达式计算的函数后，我们还需要为原有的内置表达式求值函数增加其向量化的实现版本。在本次的项目中，我们会考虑实现不同的类型的不同表达式求值函数。我们在 Expression 接口中添加了 int, real, decimal, string 的向量化表达式求值函数。在此基础上，我们为不同的类型实现了不同的表达式，我们为 int 实现了加法，为 real 实现了乘法，为 decimal 实现了 greatest 函数，为 string 实现了 concat 函数。

最后，在具体的表达式求值函数的实现上，我们需要尽量利用好机器的性能，在正确性能够保证的前提下尽量减少不计算，如对 Null 的处理，在多参数的函数中可以提前保存 null 的值，这样在计算的过程可以直接取用提前保存的 null 的值，而不是每次重新函数调用获取。一些数据也可以用类似的方法提前存到临时变量中，以此加快获取的速度。另外，对于 Column 结构，我们可以尽量复用以减少 GC 的开销，如在多参数的表达式计算中，我们可以将现有的 Column 结构不断复用，作为表达式计算的参数重复使用。

## 优势

- 提高了 cache 命中率。原来的版本中表达式的计算是以行为单位的，然而数据却是以列保存的，这样对一行进行表达式求值时，可能会出现 cache 命中率不高的情况。当以列为单位进行表达式计算时，一列中的数据可以尽量长的保留在 cache 中，可以在一定程度上提高 cache 的命中率。于此同时，作为保存中间结果的 Column 结构，其本身十分紧凑，没有过多额外的内存开销。

- 减少了函数调用的开销。在原来的表达式计算框架中，对传入的 chunk，对 chunk 中的每一行都需要进行一次函数调用。而在改进后的版本中，可以直接一次性对一个 chunk 进行整体的表达式计算，大大减少了函数调用的开销。

- 提高了表达式计算的速度。以列为对象进行表达式计算比以行为对象进行表达式计算有更多优化的可能，如当数据以列为单位进行计算时，我们可以增加数据以及指令的并行度来提高表达式计算的速度，从而获得较好的性能。

## 劣势

- 增加了内存和 GC 的开销，因为进行改进后的框架中。表达式的计算是以向量为单位的，每次表达式计算的结果都需要保存进向量中返回给调用的函数。而创建向量所带来的内存和 GC 开销是不可避免的。

## 测试

- 对一条SQL语句，在不同表达式求值框架的实现下所用的时间进行比较
- 对于相同表达式求值类型（如整数加法），求出在不同实现（原来的版本和我们进行改进的版本）下表达式求值函数所用的时间

## 兼容性问题

因为时间紧张，能力不足，我们无法完成所有类型和函数的向量化。这也导致原有的、涉及到表达式求值的框架将会出现问题。

## 其他

我们的修改基于 TiDB v3.0.1，可通过 GitHub 的 Compare 功能查看我们的代码改动了哪里：

[Comparing v3.0.1...column · CNife/tidb](https://github.com/CNife/tidb/compare/v3.0.1...CNife:column)

### 单元测试

文件：[./expression/column_evaluator_test.go](./expression/column_evaluator_test.go)

```shell
go test github.com/pingcap/tidb/expression
```
